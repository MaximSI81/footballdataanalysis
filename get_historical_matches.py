import asyncio
from datetime import datetime
from clickhouse_driver import Client
from sofascore_wrapper.api import SofascoreAPI

class TournamentMatchesCollector:
    def __init__(self, ch_host: str, ch_user: str, ch_password: str, ch_database: str = 'football_db'):
        self.ch_client = Client(
            host=ch_host,
            user=ch_user,
            password=ch_password,
            database=ch_database
        )
        self.api = None
    
    async def collect_season_data(self, tournament_id: int, season_id: int, season_name: str, rounds_count: int):
        """–°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–æ —Å–µ–∑–æ–Ω–∞"""
        
        try:
            # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä API
            self.api = SofascoreAPI()
            
            print(f"üéØ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä —Å–µ–∑–æ–Ω–∞: {season_name}")
            print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–æ–≤: {rounds_count}")
            print("=" * 50)
            
            all_matches_data = []
            successful_rounds = 0
            
            for round_number in range(1, rounds_count + 1):
                print(f"üìä –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—É—Ä {round_number}...")
                
                round_matches = await self.get_round_matches(tournament_id, season_id, round_number)
                
                if round_matches:
                    all_matches_data.extend(round_matches)
                    successful_rounds += 1
                    print(f"‚úÖ –¢—É—Ä {round_number}: {len(round_matches)} –º–∞—Ç—á–µ–π")
                else:
                    print(f"‚ö†Ô∏è  –¢—É—Ä {round_number}: –º–∞—Ç—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                
                # –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å API
                await asyncio.sleep(1)
            
            # –í—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if all_matches_data:
                self.insert_matches_data(all_matches_data)
                print(f"\nüéâ –°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω! –£—Å–ø–µ—à–Ω—ã—Ö —Ç—É—Ä–æ–≤: {successful_rounds}/{rounds_count}")
                print(f"üìä –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_matches_data)} –º–∞—Ç—á–µ–π")
                return True
            else:
                print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–µ–π")
                return False
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å–µ–∑–æ–Ω–∞ {season_name}: {e}")
            return False
        finally:
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å API
            if self.api:
                await self.api.close()
    
    async def get_round_matches(self, tournament_id: int, season_id: int, round_number: int):
        """–ü–æ–ª—É—á–∞–µ—Ç –º–∞—Ç—á–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç—É—Ä–∞"""
        try:
            endpoint = f"/unique-tournament/{tournament_id}/season/{season_id}/events/round/{round_number}"
            print(f"üîç API –∑–∞–ø—Ä–æ—Å: {endpoint}")
            
            data = await self.api._get(endpoint)
            
            matches_data = []
            for match in data.get('events', []):
                match_info = self.extract_match_info(match, tournament_id, season_id, round_number)
                if match_info:
                    matches_data.append(match_info)
            
            return matches_data
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ç—á–µ–π —Ç—É—Ä–∞ {round_number}: {e}")
            return []
    
    def extract_match_info(self, match: dict, tournament_id: int, season_id: int, round_number: int):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ç—á–µ"""
        try:
            home_score = match.get('homeScore', {}).get('current')
            away_score = match.get('awayScore', {}).get('current')
            venue = match.get('venue', {}).get('name')
            
            match_info = {
                'match_id': match['id'],
                'tournament_id': tournament_id,
                'season_id': season_id,
                'round_number': round_number,
                'match_date': datetime.fromtimestamp(match['startTimestamp']).date(),
                'home_team_id': match['homeTeam']['id'],
                'home_team_name': match['homeTeam']['name'],
                'away_team_id': match['awayTeam']['id'],
                'away_team_name': match['awayTeam']['name'],
                'home_score': home_score if home_score is not None else 0,
                'away_score': away_score if away_score is not None else 0,
                'status': match['status']['description'],
                'venue': venue if venue is not None else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'start_timestamp': datetime.fromtimestamp(match['startTimestamp']),
                'created_at': datetime.now()
            }
            return match_info
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–∞ {match.get('id')}: {e}")
            return None
    
    def insert_matches_data(self, matches_data: list):
        """–í—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–∞—Ç—á–µ–π –≤ ClickHouse"""
        try:
            if not matches_data:
                print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏")
                return
            
            query = """
            INSERT INTO football_matches (
                match_id, tournament_id, season_id, round_number, match_date,
                home_team_id, home_team_name, away_team_id, away_team_name,
                home_score, away_score, status, venue, start_timestamp, created_at
            ) VALUES
            """
            
            data = []
            for match in matches_data:
                data.append((
                    match['match_id'],
                    match['tournament_id'],
                    match['season_id'],
                    match['round_number'],
                    match['match_date'],
                    match['home_team_id'],
                    match['home_team_name'],
                    match['away_team_id'],
                    match['away_team_name'],
                    match['home_score'],
                    match['away_score'],
                    match['status'],
                    match['venue'],
                    match['start_timestamp'],
                    match['created_at']
                ))
            
            self.ch_client.execute(query, data)
            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ {len(data)} –º–∞—Ç—á–µ–π –≤ football_matches")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")

# –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ –î–õ–Ø –í–°–ï–• –¢–£–†–ù–ò–†–û–í
async def main():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —Ç—É—Ä–Ω–∏—Ä–∞–º —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ —Å–µ–∑–æ–Ω–∞–º–∏"""
    
    collector = TournamentMatchesCollector(
        ch_host='localhost',
        ch_user='username', 
        ch_password='password',
        ch_database='football_db'
    )
    
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
    TOURNAMENTS = [
        # –õ–∏–≥–∞ 1 (–§—Ä–∞–Ω—Ü–∏—è)
        {
            'id': 34,
            'name': '–õ–∏–≥–∞ 1',
            'seasons': [
                (61736, "–õ–∏–≥–∞ 1 2024/2025", 34),
                (52571, "–õ–∏–≥–∞ 1 2023/2024", 34)
            ]
        },
        # –ë—É–Ω–¥–µ—Å–ª–∏–≥–∞ (–ì–µ—Ä–º–∞–Ω–∏—è)
        {
            'id': 35,
            'name': '–ë—É–Ω–¥–µ—Å–ª–∏–≥–∞',
            'seasons': [
                (63516, "–ë—É–Ω–¥–µ—Å–ª–∏–≥–∞ 2024/2025", 34),
                (52608, "–ë—É–Ω–¥–µ—Å–ª–∏–≥–∞ 2023/2024", 34)
            ]
        },
        # –ê–Ω–≥–ª–∏–π—Å–∫–∞—è –ü—Ä–µ–º—å–µ—Ä-–õ–∏–≥–∞
        {
            'id': 17,
            'name': '–ê–Ω–≥–ª–∏–π—Å–∫–∞—è –ü—Ä–µ–º—å–µ—Ä-–õ–∏–≥–∞',
            'seasons': [
                (61627, "–ê–ü–õ 2024/2025", 38),
                (52186, "–ê–ü–õ 2023/2024", 38)
            ]
        },
        # –õ–∞ –õ–∏–≥–∞ (–ò—Å–ø–∞–Ω–∏—è)
        {
            'id': 8,
            'name': '–õ–∞ –õ–∏–≥–∞',
            'seasons': [
                (61643, "–õ–∞ –õ–∏–≥–∞ 2024/2025", 38),
                (52376, "–õ–∞ –õ–∏–≥–∞ 2023/2024", 38)
            ]
        },
        # –°–µ—Ä–∏—è –ê (–ò—Ç–∞–ª–∏—è)
        {
            'id': 23,
            'name': '–°–µ—Ä–∏—è –ê',
            'seasons': [
                (63515, "–°–µ—Ä–∏—è –ê 2024/2025", 38),
                (52760, "–°–µ—Ä–∏—è –ê 2023/2024", 38)
            ]
        },
        # –†–æ—Å—Å–∏–π—Å–∫–∞—è –ü—Ä–µ–º—å–µ—Ä-–õ–∏–≥–∞
        {
            'id': 203,
            'name': '–†–æ—Å—Å–∏–π—Å–∫–∞—è –ü—Ä–µ–º—å–µ—Ä-–õ–∏–≥–∞',
            'seasons': [
                (52470, "–†–ü–õ 2023/2024", 30),
                (61712, "–†–ü–õ 2024/2025", 30)
            ]
        }
    ]
    
    total_matches = 0
    total_seasons = 0
    
    for tournament in TOURNAMENTS:
        tournament_id = tournament['id']
        tournament_name = tournament['name']
        
        print(f"\n{'='*80}")
        print(f"üèÜ –¢–£–†–ù–ò–†: {tournament_name} (ID: {tournament_id})")
        print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∑–æ–Ω–æ–≤: {len(tournament['seasons'])}")
        print('='*80)
        
        for season_id, season_name, rounds_count in tournament['seasons']:
            print(f"\nüéØ –ó–ê–ì–†–£–ó–ö–ê –°–ï–ó–û–ù–ê: {season_name}")
            print(f"üìä –¢—É—Ä–Ω–∏—Ä: {tournament_name}, –°–µ–∑–æ–Ω: {season_id}")
            print(f"üéØ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–æ–≤: {rounds_count}")
            print('-' * 50)
            
            success = await collector.collect_season_data(
                tournament_id=tournament_id,
                season_id=season_id, 
                season_name=season_name,
                rounds_count=rounds_count
            )
            
            if success:
                print(f"üéâ –°–µ–∑–æ–Ω {season_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!")
                total_seasons += 1
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∑–æ–Ω–∞ {season_name}")
            
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å–µ–∑–æ–Ω–∞–º–∏
            print("\n‚è≥ –ü–∞—É–∑–∞ 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–µ–∑–æ–Ω–æ–º...")
            await asyncio.sleep(5)
    
    print(f"\n{'='*80}")
    print(f"üéâ –í–°–ï –¢–£–†–ù–ò–†–´ –ó–ê–ì–†–£–ñ–ï–ù–´!")
    print(f"üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–∑–æ–Ω–æ–≤: {total_seasons}")
    print(f"üìä –í—Å–µ–≥–æ —Ç—É—Ä–Ω–∏—Ä–æ–≤: {len(TOURNAMENTS)}")
    print('='*80)

if __name__ == "__main__":
    # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ - –≤—Å–µ —Ç—É—Ä–Ω–∏—Ä—ã –∏ —Å–µ–∑–æ–Ω—ã
    asyncio.run(main())